/**
 * Created by shadygabal on 12/13/15.
 */
//var express = require('express');
//var router = express.Router();
//
//var dbFolderLocation = "../../db/";
//var helpersFolderLocation = "../../helpers/";
//
//var mongoose = require('app/db/mongoose_connect.js');
//var Soiree = require('app/db/Soiree.js');
//var Business = require('app/db/Business.js');
//var User = require('app/db/User.js');
//
//var DateHelper = require('app/helpers/DateHelper.js');
//var SoireeHelper = require('app/helpers/SoireeHelper.js');

var stripe = require("stripe")(
    process.env.STRIPE_SECRET_KEY
);
/* Helper */
var Globals = require('./Globals.js');

var ccHelper = (function() {

    return {
        chargeForSoiree: function (soiree, user, successCallback, errorCallback) {
            if (user.testUser && Globals.development){
                return successCallback({test : "test"});
            }

            if (!user.stripeCustomerId)
              return errorCallback();

            //successCallback();

            var amount = soiree.initialCharge;
            console.log(amount);

            var description = "Charge for " + soiree.soireeType + " Soir√©e on " + soiree.date.toString() + ".";

            var chargeOptions = {
                amount: amount,
                currency: "usd",
                description: description
            };

            chargeOptions.customer = user.stripeCustomerId;


            stripe.charges.create(chargeOptions, function(err, charge) {

                console.log(err);
                console.log(charge.status);

                if (err){
                    errorCallback(err);
                }
                else{
                    if (!user.stripeCustomerId && charge.customer) {
                        user.stripeCustomerId = charge.customer;

                        user.save(function (err) {
                            if (err) {
                                errorCallback(err);
                            }
                            else {
                                successCallback(charge);
                            }
                        });
                    }
                    else successCallback(charge);

                }

                //console.log(charge);
                //console.log(charge.customer);

                // asynchronously called
                //if (err && err.type === 'StripeCardError') {
                //    // The card has been declined
                //}

            });

        },

        createStripeCustomerId: function(stripeToken, user, successCallback, errorCallback){

            if (!stripeToken || !user){
                return errorCallback();
            }

            if (user.stripeCustomerId){
                user.stripeCustomerId = null;

                //return stripe.customers.del(
                //    user.stripeCustomerId,
                //    function(err, confirmation) {
                //        // asynchronously called
                //        if (err){
                //            errorCallback(err);
                //        }
                //        else{
                //            successCallback(confirmation);
                //        }
                //    }
                //);

                //return successCallback();
            }

            var description = "Soiree customer: " + user.fullName;

            stripe.customers.create({
                description: description,
                source: stripeToken // obtained with Stripe.js
            }, function(err, customer) {

                if (err){
                    return errorCallback(err);
                }

                user.stripeCustomerId = customer.id;

                user.save(function(err, user){
                    if (err){
                        errorCallback(err);
                    }
                    else{
                        console.log("Saved: " + user.stripeCustomerId);
                        successCallback(customer);
                    }
                });
            });

        },

        deleteStripeCustomer: function(user, successCallback, errorCallback){
            stripe.customers.del(
                user.stripeCustomerId,
                function(err, confirmation) {
                    // asynchronously called
                    if (err){
                        errorCallback(err);
                    }
                    else{
                        user.stripeCustomerId = null;
                        successCallback(confirmation);
                    }
                }
            );
        }

    }

}());

module.exports = ccHelper;