/**
 * Created by shadygabal on 12/24/15.
 */

var emailHelper = (function() {
    var nodemailer = require('nodemailer');
    var xoauth2 = require('xoauth2');

    var generator = xoauth2.createXOAuth2Generator({
        user: 'info@experiencesoiree.com',
        pass: process.env.EMAIL_PW,
        clientId: process.env.EMAIL_CLIENT_ID,
        clientSecret: process.env.EMAIL_CLIENT_SECRET,
        refreshToken: process.env.EMAIL_REFRESH_TOKEN
        //accessToken: process.env.EMAIL_ACCESS_TOKEN
    });


    // create reusable transporter object using SMTP transport
    var transporter = nodemailer.createTransport({
        service: 'gmail',
        auth: {
            XOAuth2: generator
        }
    });

    var validator = require('validator');

    return {
        sendVerificationEmail: function (email, user, successCallback, errorCallback) {

            //user.generateVerificationCode();
            var code = user.verificationCode;
            if (!code){
                user.generateVerificationCode();
            }

            // setup e-mail data with unicode symbols
            var mailOptions = {
                //from: 'Soirée <donotreply@experiencesoiree.com>', // sender address
                to: email, // list of receivers
                subject: "Start experiencing Soirée", // Subject line
                text: "Hey " + user.firstName + ",\n\n" +
                      "It's time to begin experiencing Soirée. Enter verification code \n"  +
                      code +"\n to get started.", // plaintext body
                html: "Hey " + user.firstName + ",<br /><br />" +
                      "It's time to begin experiencing Soirée. Enter verification code <br /><br />"  +
                      "<b> " + code + " </b> <br /><br /> to get started."// html body
            };


            // send mail with defined transport object
            transporter.sendMail(mailOptions, function(error, info){
                if(error){
                    console.log(error);
                    errorCallback(error);
                }
                else {
                    console.log('Message sent: ' + info.response);
                    user.pendingVerification = true;
                    user.save();
                    successCallback();
                }

            });
        },

        validateEmail: function(email){
            return validator.isEmail(email);
        }
    }

}());

module.exports = emailHelper;






